<?php

namespace s9e\TextFormatter\Tests;

use PHPUnit_Framework_TestCase;
use s9e\Acl\BitPacker;

/**
* @covers s9e\Acl\BitPacker
*/
class BitPackerTest extends PHPUnit_Framework_TestCase
{
	/**
	* @dataProvider getMergeTests
	*/
	public function testMerge($strings, $expected)
	{
		$packer = new BitPacker;
		$actual = $packer->merge($strings);
		$this->assertSame($expected, $actual);

		foreach ($strings as $string)
		{
			$this->assertContains($string, $actual);
		}
	}

	public function getMergeTests()
	{
		return [
			[
				['01', '01'],
				'01'
			],
			[
				['10000', '01001'],
				'100001001'
			],
			[
				['1111', '0000'],
				'11110000'
			],
			[
				['11110', '11000', '11100'],
				'1111000'
			],
			[
				['011', '011111', '11100'],
				'01111100'
			],
			[
				['11010', '10101', '01010', '10100'],
				'11010100'
			],
			[
				// This test doesn't target any specific code path. It just merges 2048 strings
				// (1536 unique strings) that are between 1 and 10 characters long. It ensures that
				// things don't go haywire when we try to merge many strings
				array_merge(
					array_map('decbin', range(0, 1023)),
					array_map(
						function ($i)
						{
							return sprintf('%010b', $i);
						},
						range(0, 1023)
					)
				),
				'1100111100010100000011110001000011111111000000011010111010111100111100000100010000110011000101010001111111001000000001101000101001100111101000100011100110010010100011011110010110000011101010010011111011010000110111000101100100111010110100111101110100001001110001101001001011101101110011011001010010101111011111000010000001011000101110100100010111001110001100011101111001100001101000110110011010011010011001011011111110110000001100010001010111001111100101000010111100011100000110010001101011001011110101110000111001000100101100110111010101100111111010100000111110001100001001010101101111100100000110111011010001110111001001100101101000100101110010111001010011101011000101010110101010010101111010100001011111101000000100011110111000010011111011001001001101101101001011011101110110011001101010101011111111110000000000100100010110110011101101010011011111010010000111011000100110101110100111001110100101001110111101001100001101010001011111001110000101001000111101100100001010110001111101011000011110101010000111111000100000100110001110100011001110010101001011111101110000001000010001100011001010110101111101111000011000001010101001111111101000000011100010010010011011011000110110101101101111011011000010110101011101111110011000000010100010011110011010000010111000111100100100000110110000010'
			],
		];
	}

	/**
	* @dataProvider getToBinTests
	*/
	public function testToBin($string, $expected)
	{
		$this->assertSame($expected, BitPacker::toBin($string));
	}

	public function getToBinTests()
	{
		return [
			[
				'0',
				"\0"
			],
			[
				'1',
				"\1",
			],
			[
				'10000000',
				"\1"
			],
			[
				'1000000010000000',
				"\1\1"
			],
			[
				'00000001000000011',
				"\x80\x80\1"
			],
		];
	}
}